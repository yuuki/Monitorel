use t::monitoreltest;

use Test::Fatal;
use Test::Mock::Guard qw(mock_guard);

use Monitorel::Worker::Agent::SNMP;


subtest proc => sub {

    my $oids = [ qw(
        .1.3.6.1.2.1.2.2.1.10.2
        .1.3.6.1.2.1.2.2.1.16.2
        .1.3.6.1.4.1.2021.11.50.0
        .1.3.6.1.4.1.2021.11.51.0
        .1.3.6.1.4.1.2021.11.55.0
        .1.3.6.1.4.1.2021.11.54.0
        .1.3.6.1.4.1.2021.11.53.0
        .1.3.6.1.4.1.2021.11.56.0
        .1.3.6.1.4.1.2021.11.61.0
        .1.3.6.1.4.1.2021.13.15.1.1.5.17
        .1.3.6.1.4.1.2021.13.15.1.1.6.17
        .1.3.6.1.4.1.2021.10.1.5.2
        .1.3.6.1.4.1.2021.10.1.5.3
        .1.3.6.1.4.1.2021.4.6.0
        .1.3.6.1.4.1.2021.4.5.0
        .1.3.6.1.4.1.2021.4.4.0
        .1.3.6.1.4.1.2021.4.3.0
        .1.3.6.1.4.1.2021.4.13.0
        .1.3.6.1.4.1.2021.4.15.0
        .1.3.6.1.4.1.2021.4.14.0
        .1.3.6.1.4.1.2021.9.1.7.1
        .1.3.6.1.4.1.2021.9.1.6.1
        .1.3.6.1.4.1.2021.9.1.8.1
        .1.3.6.1.2.1.1.3.0
    ) ];

    my $snmp_request = +{
        '.1.3.6.1.4.1.2021.11.54.0'  => 56345,
        '.1.3.6.1.4.1.2021.9.1.7.1'  => 8322640,
        '.1.3.6.1.4.1.2021.4.15.0'   => 511096,
        '.1.3.6.1.4.1.2021.4.5.0'    => 2097152,
        '.1.3.6.1.4.1.2021.10.1.5.3' => 0,
        '.1.3.6.1.4.1.2021.11.50.0'  => 28758,
        '.1.3.6.1.2.1.2.2.1.10.2'    => 3556529567,
        '.1.3.6.1.4.1.2021.4.3.0'    => 2097144,
        '.1.3.6.1.4.1.2021.11.61.0'  => 188,
        '.1.3.6.1.4.1.2021.13.15.1.1.5.17' => 12763,
        '.1.3.6.1.4.1.2021.9.1.8.1'  => 1474280,
        '.1.3.6.1.4.1.2021.13.15.1.1.6.17' => 545093,
        '.1.3.6.1.4.1.2021.11.55.0'  => 0,
        '.1.3.6.1.4.1.2021.11.56.0'  => 0,
        '.1.3.6.1.4.1.2021.4.13.0'   => 'noSuchObject',
        '.1.3.6.1.4.1.2021.4.4.0'    => 2097144,
        '.1.3.6.1.4.1.2021.11.53.0'  => 545094948,
        '.1.3.6.1.4.1.2021.4.6.0'    => 1293612,
        '.1.3.6.1.4.1.2021.10.1.5.2' => 0,
        '.1.3.6.1.4.1.2021.4.14.0'   => 152600,
        '.1.3.6.1.2.1.2.2.1.16.2'    => 19964120,
        '.1.3.6.1.4.1.2021.9.1.6.1'  => 10321208,
        '.1.3.6.1.4.1.2021.11.51.0'  => 4580,
        '.1.3.6.1.2.1.1.3.0'         => '151260701344',
    };


    subtest normal => sub {
        my $mock = mock_guard 'Net::SNMP',
            +{
                session     => sub { bless {}, shift; },
                get_request => sub { $snmp_request;   },
                close       => sub {},
            };

        my $result = Monitorel::Worker::Agent::SNMP->proc({
            host      => 'localhost',
            stats     => $oids,
            community => 'public',
        });

        ok $result;
        for (@$oids) {
            ok defined $result->{$_};
        }
        is_deeply $result, $snmp_request;

    };

    subtest "invalid host" => sub {
        like exception {
            Monitorel::Worker::Agent::SNMP->proc({
                host      => 'ddd.hhh',
                stats     => $oids,
                community => 'public',
            });
        }, qr(SNMP error);
    };

    subtest "invalid oid" => sub {
        like exception {
            Monitorel::Worker::Agent::SNMP->proc({
                host      => 'localhost',
                stats     => [".1111.1111.1111.11"],
                community => 'public',
            });
        }, qr(SNMP error);
    };
};
